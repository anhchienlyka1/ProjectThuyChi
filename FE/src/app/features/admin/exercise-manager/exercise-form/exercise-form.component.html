<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-md p-8">
        <h2 class="text-3xl font-black text-gray-800 mb-6 flex items-center gap-3">
            <span class="text-4xl">üìù</span>
            {{ isEditMode ? 'Ch·ªânh s·ª≠a b√†i t·∫≠p Ti·∫øng Vi·ªát' : 'T·∫°o b√†i t·∫≠p Ti·∫øng Vi·ªát m·ªõi' }}
        </h2>

        <form [formGroup]="exerciseForm" (ngSubmit)="onSubmit()" class="space-y-8">
            <!-- SECTION 1: Basic Information -->
            <div class="border-2 border-purple-100 rounded-xl p-6 bg-purple-50/30">
                <h3 class="text-xl font-black text-purple-800 mb-4 flex items-center gap-2">
                    <span>üìã</span> Th√¥ng tin c∆° b·∫£n
                </h3>

                <div class="space-y-4">
                    <!-- Exercise Type Dropdown -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Lo·∫°i b√†i t·∫≠p *</label>
                        <select formControlName="type" (change)="onTypeChange()"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none font-semibold text-lg">
                            <option *ngFor="let type of exerciseTypes" [value]="type.value">
                                {{ type.icon }} {{ type.label }}
                            </option>
                        </select>
                    </div>

                    <!-- Title (Auto-generated) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ti√™u ƒë·ªÅ (T·ª± ƒë·ªông t·∫°o)</label>
                        <input type="text" formControlName="title" readonly
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 font-semibold text-gray-600 cursor-not-allowed" />
                        <p class="text-xs text-gray-500 mt-1">Ti√™u ƒë·ªÅ s·∫Ω t·ª± ƒë·ªông t·∫°o khi ch·ªçn lo·∫°i b√†i t·∫≠p</p>
                    </div>


                </div>
            </div>

            <!-- SECTION 2: AI Configuration -->
            <div class="border-2 border-blue-100 rounded-xl p-6 bg-blue-50/30">
                <h3 class="text-xl font-black text-blue-800 mb-4 flex items-center gap-2">
                    <span>ü§ñ</span> C·∫•u h√¨nh AI
                </h3>

                <div class="space-y-4">
                    <!-- Suggested Topics -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ch·ªçn ch·ªß ƒë·ªÅ nhanh</label>
                        <div class="flex flex-wrap gap-2">
                            <button *ngFor="let topic of suggestedTopics" type="button" (click)="selectTopic(topic)"
                                [class.bg-blue-500]="exerciseForm.value.topic === topic"
                                [class.text-white]="exerciseForm.value.topic === topic"
                                [class.bg-white]="exerciseForm.value.topic !== topic"
                                [class.text-gray-700]="exerciseForm.value.topic !== topic"
                                class="px-4 py-2 rounded-lg font-semibold border-2 border-blue-200 hover:border-blue-400 transition-all">
                                {{ topic }}
                            </button>
                        </div>
                    </div>

                    <!-- Custom Topic Input -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ho·∫∑c nh·∫≠p ch·ªß ƒë·ªÅ t√πy ch·ªânh *</label>
                        <input type="text" formControlName="topic" placeholder="VD: ƒê·ªông v·∫≠t, Hoa qu·∫£, Ph∆∞∆°ng ti·ªán..."
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none font-semibold text-lg"
                            [class.border-red-400]="exerciseForm.get('topic')?.invalid && exerciseForm.get('topic')?.touched" />
                        <p *ngIf="exerciseForm.get('topic')?.invalid && exerciseForm.get('topic')?.touched"
                            class="text-red-500 text-sm mt-1">
                            Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ
                        </p>
                    </div>

                    <!-- Question Count Slider -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            S·ªë c√¢u h·ªèi: <span class="text-blue-600 text-xl">{{ exerciseForm.value.questionCount
                                }}</span>
                        </label>
                        <input type="range" formControlName="questionCount" min="3" max="10" step="1"
                            class="w-full h-3 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>3 c√¢u</span>
                            <span>10 c√¢u</span>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Generate Button Area (Moved from AI Params section) -->
            <div class="flex justify-center py-4">
                <button type="button" (click)="generateQuestionsWithAI()" [disabled]="isGenerating"
                    class="w-full md:w-2/3 px-8 py-4 bg-gradient-to-r from-blue-400 to-indigo-600 text-white font-black text-xl rounded-2xl shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                    <span *ngIf="!isGenerating" class="flex items-center gap-2">
                        <span class="text-3xl">‚ú®</span>
                        T·ª± ƒë·ªông t·∫°o c√¢u h·ªèi (AI)
                    </span>
                    <span *ngIf="isGenerating" class="flex items-center gap-2">
                        <span class="animate-spin text-2xl">‚è≥</span>
                        ƒêang t·∫°o c√¢u h·ªèi...
                    </span>
                </button>
            </div>

            <!-- SECTION 3: Generated Questions Preview -->
            <div *ngIf="generatedQuestions.length > 0"
                class="border-2 border-orange-100 rounded-2xl p-6 md:p-8 bg-orange-50/50">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-black text-orange-600 flex items-center gap-3">
                        <span class="text-3xl">üé®</span>
                        Preview Thi·∫øt k·∫ø ({{ generatedQuestions.length }} c√¢u)
                    </h3>
                    <div
                        class="text-sm font-semibold text-orange-400 bg-white px-3 py-1 rounded-full border border-orange-200">
                        Ch·∫ø ƒë·ªô xem tr∆∞·ªõc
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div *ngFor="let question of generatedQuestions; let i = index"
                        class="group relative bg-white rounded-3xl p-6 border-2 border-gray-100 hover:border-purple-400 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">

                        <!-- Delete Button (Top Right) -->
                        <button type="button" (click)="deleteQuestion(i)"
                            class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-all z-10"
                            title="X√≥a c√¢u h·ªèi n√†y">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div class="space-y-4">
                            <!-- Question Number Badge -->
                            <div class="flex items-baseline gap-2">
                                <span
                                    class="px-2.5 py-0.5 rounded-md bg-gray-100 text-gray-500 text-xs font-bold uppercase tracking-wider">C√¢u
                                    {{ i + 1 }}</span>
                            </div>

                            <!-- Simple Words Preview: Icon + syllable slots + options -->
                            <div *ngIf="exerciseForm.value.type === 'simple-words' && isSimpleWordQuestion(question)"
                                class="space-y-3">
                                <!-- Icon -->
                                <div
                                    class="w-20 h-20 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl flex items-center justify-center border border-gray-200 mx-auto">
                                    <span class="text-5xl">{{ question.iconEmoji || 'üìù' }}</span>
                                </div>

                                <h4 class="text-2xl font-black text-gray-800 text-center">{{ question.word }}</h4>
                                <p class="text-gray-500 font-medium text-sm text-center italic">"{{
                                    question.meaning }}"</p>

                                <!-- Syllable Slots (as question marks) -->
                                <div class="flex justify-center gap-2 flex-wrap">
                                    <div *ngFor="let syllable of question.syllables"
                                        class="w-12 h-12 bg-white rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center font-black text-gray-400">
                                        ?
                                    </div>
                                </div>

                                <!-- Options Pool -->
                                <div class="flex flex-wrap gap-2 justify-center pt-2">
                                    <span *ngFor="let syllable of question.syllables"
                                        class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-sm font-bold border border-blue-600 shadow-sm">
                                        {{ syllable }}
                                    </span>
                                    <span *ngFor="let distractor of question.distractors.slice(0, 3)"
                                        class="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg text-sm font-bold border border-gray-300">
                                        {{ distractor }}
                                    </span>
                                </div>
                            </div>

                            <!-- Spelling Preview: Parts with missing indicator + options -->
                            <div *ngIf="exerciseForm.value.type === 'spelling' && isSpellingQuestion(question)"
                                class="space-y-3">
                                <h4 class="text-2xl font-black text-blue-600 text-center">{{ question.word }}</h4>
                                <p class="text-gray-500 text-sm text-center italic">üí° {{ question.hint }}</p>

                                <!-- Word parts visual -->
                                <div class="flex justify-center gap-1 mt-2">
                                    <span *ngFor="let part of question.parts"
                                        class="inline-flex w-10 h-10 items-center justify-center rounded-lg font-black text-lg border-2 shadow-sm"
                                        [class.bg-white]="!part.missing" [class.text-gray-800]="!part.missing"
                                        [class.border-gray-200]="!part.missing" [class.bg-yellow-50]="part.missing"
                                        [class.text-yellow-600]="part.missing" [class.border-yellow-200]="part.missing"
                                        [class.border-dashed]="part.missing">
                                        {{ part.missing ? '?' : part.text }}
                                    </span>
                                </div>

                                <!-- Options -->
                                <div class="flex flex-wrap gap-2 justify-center mt-3">
                                    <span *ngFor="let option of question.options"
                                        class="px-3 py-1.5 bg-purple-500 text-white rounded-lg text-sm font-bold">
                                        {{ option }}
                                    </span>
                                </div>
                            </div>

                            <!-- Fill-in-Blank Preview: Phrase with blank + options -->
                            <div *ngIf="exerciseForm.value.type === 'fill-in-blank' && isFillInBlankQuestion(question)"
                                class="space-y-3">
                                <div
                                    class="text-2xl font-bold text-gray-800 bg-gray-50 px-4 py-3 rounded-xl text-center border border-gray-200">
                                    {{ question.phrase.replace('_', '____') }}
                                </div>
                                <p class="text-gray-500 text-sm text-center">C√¢u ƒë·∫ßy ƒë·ªß: <span
                                        class="text-gray-800 font-medium">{{ question.fullText }}</span></p>

                                <!-- Correct Answer Badge -->
                                <div class="flex items-center justify-center gap-2 mt-1">
                                    <span class="text-xs font-bold text-gray-400">ƒê√°p √°n:</span>
                                    <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-bold">{{
                                        question.correctAnswer }}</span>
                                </div>

                                <!-- Options -->
                                <div class="flex flex-wrap gap-2 justify-center mt-2">
                                    <span *ngFor="let option of question.options"
                                        class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-bold border border-blue-200">
                                        {{ option }}
                                    </span>
                                </div>
                            </div>

                            <!-- Alphabet Preview: Letter + Pronunciation + Example Word -->
                            <div *ngIf="exerciseForm.value.type === 'alphabet' && isAlphabetQuestion(question)"
                                class="space-y-3">
                                <!-- Large Letter Display -->
                                <div class="flex justify-center mb-4">
                                    <div
                                        class="w-32 h-32 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-3xl flex items-center justify-center shadow-lg border-4 border-white">
                                        <span class="text-7xl font-black text-white drop-shadow-md">{{ question.letter
                                            }}</span>
                                    </div>
                                </div>

                                <!-- Pronunciation -->
                                <div class="text-center">
                                    <p class="text-gray-500 text-sm font-bold mb-1">Ph√°t √¢m:</p>
                                    <p class="text-3xl font-black text-purple-600">/{{ question.pronunciation }}/</p>
                                </div>

                                <!-- Example Word with Icon -->
                                <div
                                    class="flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                    <span class="text-4xl">{{ question.iconEmoji || 'üìù' }}</span>
                                    <div class="text-left">
                                        <p class="text-xs font-bold text-gray-500">V√≠ d·ª•:</p>
                                        <p class="text-2xl font-black text-gray-800">{{ question.word }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Sentence Builder Preview: Hint + words (will be shuffled) + correct sentence -->
                            <div *ngIf="exerciseForm.value.type === 'sentence-builder' && isSentenceBuilderQuestion(question)"
                                class="space-y-3">
                                <!-- Icon -->
                                <div
                                    class="w-20 h-20 bg-gradient-to-br from-pink-50 to-purple-50 rounded-2xl flex items-center justify-center border border-gray-200 mx-auto">
                                    <span class="text-5xl">{{ question.iconEmoji || 'üß©' }}</span>
                                </div>

                                <!-- Hint/Question -->
                                <div class="flex items-center justify-center gap-2 mb-2">
                                    <span class="text-lg">üí°</span>
                                    <p class="text-gray-700 font-bold text-lg text-center">{{ question.hint }}</p>
                                </div>

                                <!-- Words (will be shuffled in actual game) -->
                                <div
                                    class="flex flex-wrap gap-2 justify-center p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                                    <span *ngFor="let word of question.words"
                                        class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg text-base font-bold border-2 border-yellow-300 shadow-sm">
                                        {{ word }}
                                    </span>
                                </div>

                                <!-- Correct Answer -->
                                <div class="mt-3 p-3 bg-green-50 rounded-xl border border-green-200">
                                    <p class="text-xs font-bold text-gray-500 text-center mb-1">ƒê√°p √°n ƒë√∫ng:</p>
                                    <p class="text-green-700 font-black text-lg text-center">{{ question.sentence }}</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER: Action Buttons -->
            <div class="flex gap-4 pt-6 border-t-2 border-gray-200">

                <button type="submit" [disabled]="isSaving || exerciseForm.invalid || generatedQuestions.length === 0"
                    class="flex-[2] px-8 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-black text-lg rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚úÖ Xu·∫•t b·∫£n
                </button>
                <button type="button" (click)="cancel()"
                    class="flex-1 px-8 py-4 bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-500 font-black text-lg rounded-xl shadow-sm hover:shadow-md transition-all">
                    ‚ùå H·ªßy
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Full Screen Loading Overlay for AI Generation -->
<div *ngIf="isGenerating"
    class="fixed inset-0 z-[100] flex items-center justify-center bg-blue-900/40 backdrop-blur-sm animate-fade-in">
    <div
        class="bg-white rounded-3xl p-10 shadow-2xl flex flex-col items-center gap-6 max-w-xs w-full border-4 border-blue-400">
        <div class="relative">
            <div class="w-20 h-20 border-8 border-blue-100 border-t-blue-500 rounded-full animate-spin"></div>
            <span class="absolute inset-0 flex items-center justify-center text-3xl">‚ú®</span>
        </div>
        <div class="text-center">
            <h3 class="text-2xl font-black text-blue-600 mb-2">ƒêang suy nghƒ©...</h3>
            <p class="text-gray-500 font-bold">AI ƒëang t·∫°o c√¢u h·ªèi c·ª±c hay cho b√© ƒë√¢y!</p>
        </div>
    </div>
</div>

<!-- Modal Popup -->
<div *ngIf="showResultModal" class="fixed inset-0 z-[110] flex items-center justify-center p-4">
    <!-- Semi-transparent backdrop -->
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" (click)="closeModal()"></div>

    <!-- Simplified Modal Content -->
    <div class="relative bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full transform animate-pop-in">

        <div class="text-center space-y-6">
            <!-- Title -->
            <h3 class="text-3xl font-black tracking-tight" [ngClass]="{
                    'text-green-600': modalType === 'success',
                    'text-red-500': modalType === 'error',
                    'text-yellow-600': modalType === 'warning'
                }">
                {{ modalType === 'success' ? 'Th√†nh c√¥ng!' : (modalType === 'error' ? 'C√≥ l·ªói x·∫£y ra!' : 'Ch√∫ √Ω!') }}
            </h3>

            <!-- Message -->
            <p class="text-slate-600 font-bold text-lg leading-relaxed px-2">
                {{ modalMessage }}
            </p>

            <!-- Action Button -->
            <button (click)="closeModal()"
                class="w-full py-4 rounded-2xl font-black text-xl text-white bg-blue-500 hover:bg-blue-600 active:bg-blue-700 transition-all transform hover:scale-[1.02] active:scale-95 shadow-lg shadow-blue-200">
                ƒê·ªìng √Ω
            </button>
        </div>
    </div>
</div>