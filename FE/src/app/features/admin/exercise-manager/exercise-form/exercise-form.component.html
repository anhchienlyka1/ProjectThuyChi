<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-md p-8">
        <h2 class="text-3xl font-black text-gray-800 mb-6 flex items-center gap-3">
            <span class="text-4xl">üìù</span>
            {{ isEditMode ? 'Ch·ªânh s·ª≠a b√†i t·∫≠p Ti·∫øng Vi·ªát' : 'T·∫°o b√†i t·∫≠p Ti·∫øng Vi·ªát m·ªõi' }}
        </h2>

        <form [formGroup]="exerciseForm" (ngSubmit)="onSubmit()" class="space-y-8">
            <!-- SECTION 1: Basic Information -->
            <div class="border-2 border-purple-100 rounded-xl p-6 bg-purple-50/30">
                <h3 class="text-xl font-black text-purple-800 mb-4 flex items-center gap-2">
                    <span>üìã</span> Th√¥ng tin c∆° b·∫£n
                </h3>

                <div class="space-y-4">
                    <!-- Exercise Type Dropdown -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Lo·∫°i b√†i t·∫≠p *</label>
                        <select formControlName="type" (change)="onTypeChange()"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none font-semibold text-lg">
                            <option *ngFor="let type of exerciseTypes" [value]="type.value">
                                {{ type.icon }} {{ type.label }}
                            </option>
                        </select>
                    </div>

                    <!-- Title (Auto-generated) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ti√™u ƒë·ªÅ (T·ª± ƒë·ªông t·∫°o)</label>
                        <input type="text" formControlName="title" readonly
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-gray-50 font-semibold text-gray-600 cursor-not-allowed" />
                        <p class="text-xs text-gray-500 mt-1">Ti√™u ƒë·ªÅ s·∫Ω t·ª± ƒë·ªông t·∫°o khi ch·ªçn lo·∫°i b√†i t·∫≠p</p>
                    </div>

                    <!-- Tags (Optional) -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Tags (Ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
                        <input type="text" formControlName="tags" placeholder="VD: ƒë·ªông v·∫≠t, d·ªÖ, cho tr·∫ª"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none font-semibold" />
                    </div>
                </div>
            </div>

            <!-- SECTION 2: AI Configuration -->
            <div class="border-2 border-blue-100 rounded-xl p-6 bg-blue-50/30">
                <h3 class="text-xl font-black text-blue-800 mb-4 flex items-center gap-2">
                    <span>ü§ñ</span> C·∫•u h√¨nh AI
                </h3>

                <div class="space-y-4">
                    <!-- Suggested Topics -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ch·ªçn ch·ªß ƒë·ªÅ nhanh</label>
                        <div class="flex flex-wrap gap-2">
                            <button *ngFor="let topic of suggestedTopics" type="button" (click)="selectTopic(topic)"
                                [class.bg-blue-500]="exerciseForm.value.topic === topic"
                                [class.text-white]="exerciseForm.value.topic === topic"
                                [class.bg-white]="exerciseForm.value.topic !== topic"
                                [class.text-gray-700]="exerciseForm.value.topic !== topic"
                                class="px-4 py-2 rounded-lg font-semibold border-2 border-blue-200 hover:border-blue-400 transition-all">
                                {{ topic }}
                            </button>
                        </div>
                    </div>

                    <!-- Custom Topic Input -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Ho·∫∑c nh·∫≠p ch·ªß ƒë·ªÅ t√πy ch·ªânh *</label>
                        <input type="text" formControlName="topic" placeholder="VD: ƒê·ªông v·∫≠t, Hoa qu·∫£, Ph∆∞∆°ng ti·ªán..."
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none font-semibold text-lg"
                            [class.border-red-400]="exerciseForm.get('topic')?.invalid && exerciseForm.get('topic')?.touched" />
                        <p *ngIf="exerciseForm.get('topic')?.invalid && exerciseForm.get('topic')?.touched"
                            class="text-red-500 text-sm mt-1">
                            Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ
                        </p>
                    </div>

                    <!-- Question Count Slider -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            S·ªë c√¢u h·ªèi: <span class="text-blue-600 text-xl">{{ exerciseForm.value.questionCount
                                }}</span>
                        </label>
                        <input type="range" formControlName="questionCount" min="3" max="10" step="1"
                            class="w-full h-3 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>3 c√¢u</span>
                            <span>10 c√¢u</span>
                        </div>
                    </div>

                    <!-- Difficulty Selector -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ƒê·ªô kh√≥</label>
                        <div class="flex gap-3">
                            <button *ngFor="let diff of difficulties" type="button"
                                (click)="exerciseForm.patchValue({difficulty: diff.value})"
                                [class]="exerciseForm.value.difficulty === diff.value ? diff.class + ' ring-4 ring-offset-2' : 'bg-gray-200 text-gray-700'"
                                class="flex-1 px-4 py-3 rounded-xl font-black text-lg transition-all shadow-md hover:shadow-lg">
                                {{ diff.label }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Button Area (Moved from AI Params section) -->
            <div class="flex justify-center py-4">
                <button type="button" (click)="generateQuestionsWithAI()" [disabled]="isGenerating"
                    class="w-full md:w-2/3 px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black text-xl rounded-2xl shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                    <span *ngIf="!isGenerating" class="flex items-center gap-2">
                        <span class="text-3xl">‚ú®</span>
                        T·ª± ƒë·ªông t·∫°o c√¢u h·ªèi (AI)
                    </span>
                    <span *ngIf="isGenerating" class="flex items-center gap-2">
                        <span class="animate-spin text-2xl">‚è≥</span>
                        ƒêang t·∫°o c√¢u h·ªèi...
                    </span>
                </button>
            </div>

            <!-- SECTION 3: Generated Questions Preview -->
            <div *ngIf="generatedQuestions.length > 0"
                class="border-2 border-orange-100 rounded-xl p-6 bg-orange-50/30">
                <h3 class="text-xl font-black text-orange-800 mb-4 flex items-center gap-2">
                    <span>üëÄ</span> Preview C√¢u h·ªèi ({{ generatedQuestions.length }} c√¢u)
                </h3>

                <div class="space-y-4">
                    <div *ngFor="let question of generatedQuestions; let i = index"
                        class="bg-white rounded-xl p-5 border-2 border-gray-200 hover:border-purple-300 transition-all">
                        <div class="flex items-start justify-between mb-3">
                            <span class="text-lg font-black text-purple-600">C√¢u {{ i + 1 }}</span>
                            <div class="flex gap-2">
                                <button type="button" (click)="deleteQuestion(i)"
                                    class="px-3 py-1 bg-red-100 text-red-700 rounded-lg font-semibold text-sm hover:bg-red-200 transition-all">
                                    üóëÔ∏è X√≥a
                                </button>
                            </div>
                        </div>

                        <!-- Simple Words Preview -->
                        <div *ngIf="exerciseForm.value.type === 'simple-words' && isSimpleWordQuestion(question)"
                            class="space-y-2">
                            <p class="font-bold text-lg">T·ª´: <span class="text-green-600">{{ question.word }}</span></p>
                            <p class="text-gray-600">Nghƒ©a: {{ question.meaning }}</p>
                            <p class="text-sm text-gray-500">√Çm ti·∫øt: {{ question.syllables?.join(', ') }}</p>
                            <p *ngIf="question.distractors.length" class="text-sm text-orange-600">
                                Ch·ªØ nhi·ªÖu: {{ question.distractors.join(', ') }}
                            </p>
                        </div>

                        <!-- Spelling Preview -->
                        <div *ngIf="exerciseForm.value.type === 'spelling' && isSpellingQuestion(question)"
                            class="space-y-2">
                            <p class="font-bold text-lg">T·ª´: <span class="text-blue-600">{{ question.word }}</span></p>
                            <p class="text-gray-600">G·ª£i √Ω: {{ question.hint }}</p>
                            <p class="text-sm text-gray-500">
                                Ph·∫ßn t·∫°o th√†nh:
                                <span *ngFor="let part of question.parts" [class.text-red-600]="part.missing">
                                    {{ part.text }}{{ part.missing ? ' (?)' : '' }}
                                </span>
                            </p>
                            <p class="text-sm text-purple-600">L·ª±a ch·ªçn: {{ question.options.join(', ') }}</p>
                        </div>

                        <!-- Fill-in-Blank Preview -->
                        <div *ngIf="exerciseForm.value.type === 'fill-in-blank' && isFillInBlankQuestion(question)"
                            class="space-y-2">
                            <p class="font-bold text-lg">C·ª•m t·ª´: <span class="text-teal-600">{{ question.phrase
                                    }}</span></p>
                            <p class="text-gray-600">ƒê·∫ßy ƒë·ªß: {{ question.fullText }}</p>
                            <p class="text-green-600 font-medium">ƒê√°p √°n: {{ question.correctAnswer }}</p>
                            <p class="text-sm text-purple-600">L·ª±a ch·ªçn: {{ question.options.join(', ') }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER: Action Buttons -->
            <div class="flex gap-4 pt-6 border-t-2 border-gray-200">
                <button type="button" (click)="saveDraft()" [disabled]="isSaving"
                    class="flex-1 px-8 py-4 bg-gray-500 hover:bg-gray-600 text-white font-black text-lg rounded-xl shadow-md hover:shadow-lg transition-all disabled:opacity-50">
                    üíæ L∆∞u nh√°p
                </button>
                <button type="submit" [disabled]="isSaving || exerciseForm.invalid || generatedQuestions.length === 0"
                    class="flex-1 px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-black text-lg rounded-xl shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚úÖ Xu·∫•t b·∫£n
                </button>
                <button type="button" (click)="cancel()"
                    class="px-8 py-4 bg-white border-2 border-gray-300 hover:bg-gray-50 text-gray-700 font-black text-lg rounded-xl shadow-md hover:shadow-lg transition-all">
                    ‚ùå H·ªßy
                </button>
            </div>
        </form>
    </div>
</div>